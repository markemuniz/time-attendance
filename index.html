<!DOCTYPE html>
<html lang="en">
<head><link rel="icon" type="image/png" href="favicon6.png">
</head>
<meta charset="UTF-8" />
<title>The Travel Agency Attendance — v2 (Edited Times Support)</title>
<style>
/* =============================================
   TTA Attendance — v2
   Changes in this version:
   - Support for "edited" clock in/out and late/early values
   - Toggle to prefer edited values when present
   - Visual badge in the table when an edited value is being used
   - Stricter logic: only count clock-IN tardies (>= 8 min); never count clock-outs
   - Backward-compatible with v1 saved data; adds migration on load
   ============================================= */

/* Global styles */
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f7fa;
  color: #333;
}

/* Container styling */
.container {
  max-width: 1200px;
  margin: 20px auto;
  background-color: #fff;
  padding: 20px 30px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Title styling */
.title {
  margin: 0 0 12px;
  font-size: 28px;
  text-align: center;
  color: #2c3e50;
}
.subtle {
  text-align: center;
  margin-top: -6px;
  margin-bottom: 16px;
  font-size: 12px;
  color: #667085;
}

/* Controls styling */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  align-items: flex-end;
  margin-bottom: 20px;
}
.control-group {
  display: flex;
  flex-direction: column;
}
.control-label {
  margin-bottom: 4px;
  font-weight: 600;
}
.control-input,
.control-select,
.control-button {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}
.control-select:disabled,
.control-button:disabled,
.control-input:disabled {
  background-color: #eee;
  cursor: not-allowed;
}
.control-button {
  background-color: #007bff;
  color: #fff;
  border: none;
  cursor: pointer;
  transition: background-color 0.2s ease;
}
.control-button:hover:not(:disabled) { background-color: #0056b3; }

.toggle {
  display: inline-flex;
  gap: 8px;
  align-items: center;
}

/* Table styling */
.table-container { overflow-x: auto; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
  min-width: 720px;
}

th, td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #e1e4e8;
}

th {
  background-color: #f0f2f5;
  font-weight: 700;
  color: #333;
}

tr:nth-child(even) { background-color: #fafafa; }
tr:hover { background-color: #f5f5f5; }

/* Status styling */
.status-call_out { color: #c0392b; font-weight: 700; }
.status-tardy { color: #e67e22; font-weight: 700; }
.badge-edited {
  display: inline-block;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 6px;
  background: #eef2ff;
  color: #3949ab;
  border: 1px solid #c7d2fe;
  margin-left: 6px;
}

/* Summary styling */
.summary {
  font-weight: 700;
  margin-top: 10px;
  color: #2c3e50;
}

</style>
</head>
<body>
  <div class="container">
    <h1 class="title">The Travel Agency Attendance</h1>
    <div class="subtle">v2 • Edited-times aware • Only clock-in tardies ≥ 8 min are counted</div>

    <div class="controls">
      <div class="control-group">
        <label for="fileInput" class="control-label">Upload Report:</label>
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="control-input" />
      </div>

      <div class="control-group">
        <label for="nameSelect" class="control-label">Employee:</label>
        <select id="nameSelect" disabled class="control-select">
          <option value="all">All</option>
        </select>
      </div>

      <div class="control-group">
        <label for="dateSelect" class="control-label">Date:</label>
        <select id="dateSelect" disabled class="control-select">
          <option value="all">All</option>
        </select>
      </div>

      <div class="control-group">
        <label class="control-label">Use edited values:</label>
        <label class="toggle">
          <input type="checkbox" id="preferEdited" checked /> Prefer edited when available
        </label>
      </div>

      <div class="control-group">
        <button id="clearBtn" disabled class="control-button">Clear Saved Data</button>
      </div>
    </div>

    <div class="table-container">
      <table id="reportTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Name</th>
            <th>Scheduled Shift</th>
            <th>Clock In</th>
            <th>Minutes Late</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="summary" class="summary"></div>
  </div>

  <!-- SheetJS for Excel parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
  // ========================= Utilities =========================
  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (inQuotes) {
        if (char === '"') {
          if (i + 1 < line.length && line[i + 1] === '"') { current += '"'; i++; }
          else { inQuotes = false; }
        } else { current += char; }
      } else {
        if (char === '"') inQuotes = true;
        else if (char === ',') { result.push(current); current = ''; }
        else current += char;
      }
    }
    result.push(current);
    return result;
  }

  function parseCSV(content) {
    let lines = content.replace(/\r/g, '').split('\n');
    lines = lines.filter(l => l.trim() !== '');
    if (lines.length === 0) return [];
    const header = parseCSVLine(lines[0]);
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const fields = parseCSVLine(lines[i]);
      if (fields.length !== header.length) continue;
      const row = {};
      for (let j = 0; j < header.length; j++) row[header[j]] = fields[j];
      rows.push(row);
    }
    return rows;
  }

  function toISO(dateStr) {
    const d = new Date(dateStr);
    return isNaN(d) ? String(dateStr || '').slice(0, 10) : d.toISOString().slice(0, 10);
  }

  // Try a bunch of likely column names for edited fields
  function pickEdited(row, keys) {
    for (const k of keys) {
      if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== '') return row[k];
    }
    return '';
  }

  // Extract a number (minutes) from strings like "14 minutes", "-3", etc.
  function extractMinutes(str) {
    if (!str) return null;
    const m = String(str).match(/(-?\d+)/);
    return m ? parseInt(m[1], 10) : null;
  }

  // ========================= Data Model =========================
  let dataset = []; // stored rows (both raw and edited values preserved)

  function loadDataset() {
    const saved = localStorage.getItem('attendanceDataset');
    if (!saved) return;
    try {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed)) dataset = parsed;
      // Migration for v1 -> v2
      dataset.forEach(item => {
        // v1 used rawClockTime/rawDiffMinutes and optional status; normalize.
        if (item.status) { if (item.status === 'call_out') item.callOut = true; if (item.status === 'tardy') item.tardyFlag = true; delete item.status; }
        if (item.rawClockTime === undefined && item.clockTime !== undefined) item.rawClockTime = item.clockTime;
        if (item.rawDiffMinutes === undefined && item.diffMinutes !== undefined) item.rawDiffMinutes = item.diffMinutes;
        if (item.isClockInType === undefined) item.isClockInType = item.type ? /clock-?in/i.test(item.type) : (item.rawClockTime !== '');
        // Ensure edited fields exist
        if (item.editedClockTime === undefined) item.editedClockTime = '';
        if (item.editedDiffMinutes === undefined) item.editedDiffMinutes = null;
        if (item.editedType === undefined) item.editedType = '';
        if (item.hasEdited === undefined) item.hasEdited = false;
      });
    } catch (e) {
      console.warn('Failed to parse saved dataset:', e);
    }
  }

  function saveDataset() {
    try { localStorage.setItem('attendanceDataset', JSON.stringify(dataset)); }
    catch (e) { console.warn('Unable to save dataset:', e); }
  }

  // Convert a raw CSV/Excel row into our internal object, capturing both raw and edited variants when present.
  function convertRow(row) {
    const shift = row['Shift Time'] || row['Shift'] || '';

    // Base (raw) fields
    const rawType = row['Type'] || row['Event Type'] || '';
    const rawClock = row['Clock In/Out Time'] || row['Clock Time'] || row['Time'] || '';
    const rawLate = row['Late/Early'] || row['Late/Early (mins)'] || row['Minutes Late/Early'] || '';

    // Edited variants: try a series of likely column names
    const editedType = pickEdited(row, [
      'Edited Type', 'Type (Edited)', 'Edited_Type'
    ]);

    const editedClock = pickEdited(row, [
      'Edited Clock In/Out Time', 'Clock In/Out Time (Edited)', 'Edited Clock Time', 'Edited Time', 'Edited_Clock_Time'
    ]);

    const editedLate = pickEdited(row, [
      'Edited Late/Early', 'Late/Early (Edited)', 'Edited Minutes Late/Early', 'Edited_Late_Early'
    ]);

    const hasEdited = Boolean((editedType && editedType !== rawType) || (editedClock && editedClock !== rawClock) || (editedLate && editedLate !== rawLate));

    const rawDiff = extractMinutes(rawLate);
    const editedDiff = extractMinutes(editedLate);

    const isClockInTypeRaw = /clock-?in/i.test(rawType || '');
    const isClockInTypeEdited = /clock-?in/i.test(editedType || '');

    return {
      date: toISO(row['Date']),
      name: row['Name'] || row['Employee'] || '',
      shiftTime: shift,

      // raw values
      rawClockTime: rawClock,
      rawDiffMinutes: rawDiff,
      type: rawType,
      isClockInType: isClockInTypeRaw,

      // edited values
      editedClockTime: editedClock || '',
      editedDiffMinutes: (editedDiff !== null ? editedDiff : null),
      editedType: editedType || '',
      isClockInTypeEdited: isClockInTypeEdited,
      hasEdited: hasEdited,

      // derived flags (may be recomputed on render)
      callOut: undefined,   // compute at render time from chosen values
      tardyFlag: undefined  // compute at render time from chosen values
    };
  }

  // ========================= UI Binding =========================
  function populateDropdowns() {
    const nameSelect = document.getElementById('nameSelect');
    const dateSelect = document.getElementById('dateSelect');
    const names = new Set();
    const dates = new Set();
    dataset.forEach(item => { if (item.name) names.add(item.name); if (item.date) dates.add(item.date); });
    nameSelect.innerHTML = '<option value="all">All</option>';
    dateSelect.innerHTML = '<option value="all">All</option>';
    Array.from(names).sort().forEach(n => {
      const opt = document.createElement('option');
      opt.value = n; opt.textContent = n; nameSelect.appendChild(opt);
    });
    Array.from(dates).sort().forEach(d => {
      const opt = document.createElement('option');
      opt.value = d; opt.textContent = d; dateSelect.appendChild(opt);
    });
    nameSelect.disabled = false;
    dateSelect.disabled = false;
    document.getElementById('clearBtn').disabled = dataset.length === 0;
  }

  function render() {
    const nameSel = document.getElementById('nameSelect').value;
    const dateSel = document.getElementById('dateSelect').value;
    const preferEdited = document.getElementById('preferEdited').checked;

    const tbody = document.getElementById('reportTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';

    const filtered = dataset.filter(item => {
      const matchName = nameSel === 'all' || item.name === nameSel;
      let matchDate = true;
      if (dateSel !== 'all') matchDate = item.date >= dateSel; // inclusive from selected date
      return matchName && matchDate;
    });

    filtered.sort((a, b) => {
      if (a.date < b.date) return -1; if (a.date > b.date) return 1;
      if (a.name < b.name) return -1; if (a.name > b.name) return 1;
      return 0;
    });

    let tardyCount = 0;
    let callOutCount = 0;

    filtered.forEach(item => {
      // Choose which values to use (edited vs raw)
      const useEdited = preferEdited && item.hasEdited;
      const chosenClock = useEdited ? (item.editedClockTime || '') : (item.rawClockTime || '');
      const chosenDiff = useEdited ? (item.editedDiffMinutes) : (item.rawDiffMinutes);
      const chosenIsClockIn = useEdited ? (item.isClockInTypeEdited !== undefined ? item.isClockInTypeEdited : /clock-?in/i.test(item.editedType || ''))
                                        : (item.isClockInType !== undefined ? item.isClockInType : /clock-?in/i.test(item.type || ''));

      // Determine derived flags
      const callOut = (chosenClock === '' && (item.shiftTime || '') !== '');
      const isTardy = chosenIsClockIn && (chosenDiff !== null && chosenDiff >= 8);

      // Update counters
      if (callOut) callOutCount++; else if (isTardy) tardyCount++;

      // Only display rows that are call-outs or tardies
      if (!callOut && !isTardy) return;

      // Display values (never show clock-out times/minutes)
      const displayClock = chosenIsClockIn ? (chosenClock || '') : '';
      const displayDiff = chosenIsClockIn ? (chosenDiff !== null && chosenDiff !== undefined ? chosenDiff : '') : '';

      const statusStr = callOut ? 'Call Out' : 'Tardy';
      const statusClass = callOut ? 'status-call_out' : 'status-tardy';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.date}</td>
        <td>${item.name}</td>
        <td>${item.shiftTime}</td>
        <td>${displayClock}${useEdited && displayClock ? '<span class="badge-edited">edited</span>' : ''}</td>
        <td>${displayDiff !== '' ? displayDiff : ''}${useEdited && displayDiff !== '' ? '<span class="badge-edited">edited</span>' : ''}</td>
        <td class="${statusClass}">${statusStr}</td>
      `;
      tbody.appendChild(tr);
    });

    const summaryElem = document.getElementById('summary');
    if (nameSel !== 'all' || dateSel !== 'all')
      summaryElem.textContent = `Tardies: ${tardyCount}, Call Outs: ${callOutCount}`;
    else summaryElem.textContent = '';
  }

  // ========================= File Handling =========================
  function handleFile(file) {
    const ext = file.name.split('.').pop().toLowerCase();

    if (ext === 'csv') {
      const reader = new FileReader();
      reader.onload = e => {
        const content = e.target.result;
        const rows = parseCSV(content);
        const newData = rows.map(r => convertRow(r));
        dataset = dataset.concat(newData);
        saveDataset();
        populateDropdowns();
        render();
        alert(`Loaded ${newData.length} records from CSV. Total records: ${dataset.length}`);
      };
      reader.readAsText(file);
    } else if (ext === 'xlsx' || ext === 'xls') {
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        const newData = json.map(r => convertRow(r));
        dataset = dataset.concat(newData);
        saveDataset();
        populateDropdowns();
        render();
        alert(`Loaded ${newData.length} records from Excel sheet ${sheetName}. Total records: ${dataset.length}`);
      };
      reader.readAsArrayBuffer(file);
    } else {
      alert('Unsupported file type: ' + ext);
    }
  }

  function clearData() {
    if (confirm('Are you sure you want to clear all saved attendance data?')) {
      dataset = [];
      saveDataset();
      populateDropdowns();
      render();
    }
  }

  // ========================= Events =========================
  document.getElementById('fileInput').addEventListener('change', () => {
    const file = document.getElementById('fileInput').files[0];
    if (file) handleFile(file);
  });
  document.getElementById('nameSelect').addEventListener('change', render);
  document.getElementById('dateSelect').addEventListener('change', render);
  document.getElementById('preferEdited').addEventListener('change', render);
  document.getElementById('clearBtn').addEventListener('click', clearData);

  // Init
  window.addEventListener('DOMContentLoaded', () => {
    loadDataset();
    populateDropdowns();
    render();
  });
  </script>
</body>
</html>
